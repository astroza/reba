#!/usr/bin/env bash

function govjs_generator() {
cat << __EOS__
console.log("* Reba governator generated by reba_local_run");
var groups = [];
var worker_script;
__EOS__
script_content=$(cat $2)
cat << __EOS__
worker_script = \`
$script_content
\`;
var group = new WorkerGroup(worker_script);
router.addHost('$1', group);
__EOS__
cat << __EOS__
console.log("* Fiberware Reba governator loaded");
__EOS__
}
PORT=$1
shift
TMP_FILE=govjs_$(base64 /dev/urandom | tr -d '/+' | dd bs=32 count=1 2>/dev/null)
govjs_generator $@ > /tmp/$TMP_FILE

REBA=./reba
SYSTEM_REBA=$(which reba)
if [ "x$SYSTEM_REBA" != "x" ]; then
	REBA=$SYSTEM_REBA
fi
echo "Executing: $REBA /tmp/$TMP_FILE $PORT"
$REBA /tmp/$TMP_FILE $PORT
rm -f /tmp/$TMP_FILE
